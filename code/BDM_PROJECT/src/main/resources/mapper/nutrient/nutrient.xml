<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.test.bdm.nutrient">
  
      <select id = "doRetrieveWeek" parameterType = "map" resultType = "NutrientVO">
        SELECT SUM(kcal) AS kcal,
               SUM(carbohydrate) AS carbohydrate,
               SUM(protein) AS protein,
               SUM(fat) AS fat,
               SUM(sugars) AS sugars,
               COUNT(*)
        FROM nutrient
        WHERE code IN (
		    SELECT code
		    FROM eat
		    WHERE REG_DT  BETWEEN TO_DATE(#{startDate},'YY/MM/DD HH24:MI:SS"') AND TO_DATE(#{finishDate},'YY/MM/DD HH24:MI:SS')
		    AND id = #{userId}
        )
      </select>
    
      <select id="doRetrieveOneDay" parameterType = "map" resultType = "NutrientVO">
        SELECT SUM(kcal) AS kcal,
               SUM(carbohydrate) AS carbohydrate,
               SUM(protein) AS protein,
               SUM(fat) AS fat,
               SUM(sugars) AS sugars
        FROM nutrient
        WHERE code IN (
		    SELECT code
		    FROM eat
		    WHERE TO_CHAR(reg_dt, 'YY/MM/DD') = #{formatedNow}
		    AND id = #{userId}
        )
      </select>
  
      <select id="doRetrieve" parameterType="NutrientVO" 
      resultType="NutrientVO">
	    SELECT A.*,B.totalCnt
	    FROM (
	        SELECT tt1.code,
	               tt1.name,
	               tt1.norm,
	               tt1.kcal,
	               tt1.carbohydrate,
	               tt1.protein,
	               tt1.fat,
	               tt1.sugars,
	               tt1.weight
	        FROM (
	            SELECT ROWNUM rnum, T1.*
	            FROM (
	                SELECT *
	                FROM nutrient
	                WHERE name LIKE '%' || #{searchWord} || '%'
	                ORDER BY name ASC
	            )T1
	          <![CDATA[   WHERE ROWNUM <=#{pageSize} * (#{pageNo}-1) + #{pageSize} ]]>
	        )TT1
	        <![CDATA[ WHERE rnum >= #{pageSize} * (#{pageNo}-1) + 1 ]]>
	    )A
	    CROSS JOIN (
	        SELECT COUNT(*) totalCnt
	        FROM nutrient
	        WHERE name LIKE '%' || #{searchWord} || '%'
	    )B  
	  </select>
  </mapper>